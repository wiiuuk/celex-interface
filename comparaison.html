{% extends "base.html" %}

{% block title %}Comparaison Prix et Distance{% endblock %}
{% block header %}Comparaison des Prix et Distances{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5>Comparateur de Prix</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Sélectionner un produit</label>
                    <select class="form-select" id="produitPrix">
                        <option value="">Choisir un produit</option>
                        {% for produit in produits %}
                        <option value="{{ produit.id }}">{{ produit.nom }}</option>
                        {% endfor %}
                    </select>
                </div>
                <button class="btn btn-primary" onclick="comparerPrix()">
                    <i class="fas fa-search me-2"></i>Comparer les prix
                </button>
                
                <div id="resultatsPrix" class="mt-3"></div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5>Fournisseur le Plus Proche</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Chantier</label>
                    <select class="form-select" id="chantierDistance">
                        <option value="">Choisir un chantier</option>
                        {% for chantier in chantiers %}
                        <option value="{{ chantier.id }}">{{ chantier.nom }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Produit</label>
                    <select class="form-select" id="produitDistance">
                        <option value="">Choisir un produit</option>
                        {% for produit in produits %}
                        <option value="{{ produit.id }}">{{ produit.nom }}</option>
                        {% endfor %}
                    </select>
                </div>
                <button class="btn btn-primary" onclick="trouverFournisseurProche()">
                    <i class="fas fa-map-marker-alt me-2"></i>Trouver le plus proche
                </button>
                
                <div id="resultatsDistance" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>

<div class="card mt-4">
    <div class="card-header">
        <h5>Ajouter une Offre de Prix</h5>
    </div>
    <div class="card-body">
        <form method="POST" action="{{ url_for('ajouter_offre_prix') }}">
            <div class="row">
                <div class="col-md-3">
                    <label class="form-label">Produit</label>
                    <select class="form-select" name="produit_id" required>
                        <option value="">Choisir un produit</option>
                        {% for produit in produits %}
                        <option value="{{ produit.id }}">{{ produit.nom }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Fournisseur</label>
                    <select class="form-select" name="fournisseur_id" required>
                        <option value="">Choisir un fournisseur</option>
                        {% for fournisseur in fournisseurs %}
                        <option value="{{ fournisseur.id }}">{{ fournisseur.nom }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Prix (FCFA)</label>
                    <input type="number" step="0.01" class="form-control" name="prix" required>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Délai (jours)</label>
                    <input type="number" class="form-control" name="delai_livraison" required>
                </div>
                <div class="col-md-2">
                    <label class="form-label">&nbsp;</label>
                    <button type="submit" class="btn btn-success w-100">
                        <i class="fas fa-plus me-2"></i>Ajouter
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function comparerPrix() {
    const produitId = document.getElementById('produitPrix').value;
    if (!produitId) {
        alert('Veuillez sélectionner un produit');
        return;
    }
    
    fetch(`/comparer_prix?produit_id=${produitId}`)
        .then(response => response.json())
        .then(data => {
            let html = '<h6>Résultats de comparaison:</h6>';
            if (data.length > 0) {
                html += '<div class="list-group">';
                data.forEach(offre => {
                    html += `
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between">
                            <strong>${offre.fournisseur}</strong>
                            <span class="badge bg-primary price-badge">${offre.prix} FCFA</span>
                        </div>
                        <small>Délai: ${offre.delai} jours - Tel: ${offre.telephone || 'N/A'}</small>
                    </div>`;
                });
                html += '</div>';
            } else {
                html += '<p class="text-muted">Aucune offre trouvée pour ce produit</p>';
            }
            document.getElementById('resultatsPrix').innerHTML = html;
        });
}

function trouverFournisseurProche() {
    const chantierId = document.getElementById('chantierDistance').value;
    const produitId = document.getElementById('produitDistance').value;
    
    if (!chantierId || !produitId) {
        alert('Veuillez sélectionner un chantier et un produit');
        return;
    }
    
    fetch(`/trouver_fournisseur_proche?chantier_id=${chantierId}&produit_id=${produitId}`)
        .then(response => response.json())
        .then(data => {
            let html = '<h6>Fournisseur le plus proche:</h6>';
            if (data.error) {
                html += `<p class="text-danger">${data.error}</p>`;
            } else {
                html += `
                <div class="card">
                    <div class="card-body">
                        <h6>${data.fournisseur}</h6>
                        <p><strong>Prix:</strong> ${data.prix} FCFA</p>
                        <p><strong>Distance:</strong> ${data.distance} km</p>
                        <p><strong>Adresse:</strong> ${data.adresse}</p>
                        <p><strong>Téléphone:</strong> ${data.telephone || 'N/A'}</p>
                    </div>
                </div>`;
            }
            document.getElementById('resultatsDistance').innerHTML = html;
        });
}
</script>
{% endblock %}